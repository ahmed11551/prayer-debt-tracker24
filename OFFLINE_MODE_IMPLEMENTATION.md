# Реализация офлайн-режима для модуля "Умный Тасбих"

## ✅ Выполнено

### 1. Офлайн-режим с IndexedDB для очереди событий

**Файл:** `src/lib/offline-queue.ts`

**Функционал:**
- ✅ Инициализация IndexedDB с хранилищами для событий и сессий
- ✅ Добавление событий в очередь (`queueEvent`)
- ✅ Добавление сессий в очередь (`queueSession`)
- ✅ Получение несинхронизированных событий (`getUnsyncedEvents`)
- ✅ Получение несинхронизированных сессий (`getUnsyncedSessions`)
- ✅ Отметка событий/сессий как синхронизированных
- ✅ Увеличение счетчика попыток при ошибках
- ✅ Очистка старых записей (старше 30 дней)
- ✅ Статистика очереди (`getQueueStats`)

**Структура базы данных:**
- `events` - хранилище для событий (tap, bulk, repeat, etc.)
- `sessions` - хранилище для сессий
- Индексы: `synced`, `created_at`

---

### 2. Синхронизация с сервером при восстановлении связи

**Файл:** `src/lib/offline-sync.ts`

**Функционал:**
- ✅ Определение онлайн/офлайн статуса (`isOnline`)
- ✅ Обработчики изменения статуса (`setupOnlineListener`)
- ✅ Автоматическая синхронизация при восстановлении связи
- ✅ Периодическая синхронизация (каждые 30 секунд)
- ✅ Синхронизация событий (`syncEvent`)
- ✅ Синхронизация сессий (`syncSession`)
- ✅ Пакетная синхронизация всей очереди (`syncQueue`)
- ✅ Автоматический запуск синхронизации (`startAutoSync`)
- ✅ Очистка старых записей (каждые 24 часа)
- ✅ Максимальное количество попыток (5 раз)

**Интеграция:**
- ✅ Инициализация в `App.tsx` при загрузке приложения
- ✅ Автоматический запуск при старте
- ✅ Обработка событий онлайн/офлайн

---

### 3. API эндпоинты для сохранения сессий и логов

**Файл:** `src/lib/api.ts` (добавлен `dhikrAPI`)

**Эндпоинты:**
- ✅ `GET /api/v1/bootstrap` - получение состояния для инициализации
- ✅ `POST /api/v1/goals` - создание/обновление цели
- ✅ `POST /api/v1/sessions/start` - начало сессии
- ✅ `POST /api/v1/counter/tap` - фиксация действия (tap)
- ✅ `POST /api/v1/learn/mark` - отметка о заучивании
- ✅ `GET /api/v1/reports/daily` - ежедневный отчет

**Интеграция в SmartTasbih:**
- ✅ Создание сессии при начале азкаров
- ✅ Логирование событий при каждом тапе
- ✅ Автоматическое добавление в очередь при офлайн-режиме
- ✅ Автоматическая синхронизация при восстановлении связи

---

## Архитектура

### Поток данных:

1. **Пользователь выполняет действие** (tap, bulk, etc.)
   ↓
2. **Проверка онлайн-статуса**
   ↓
3. **Если онлайн:**
   - Попытка отправить на сервер через `dhikrAPI`
   - При ошибке → добавление в очередь
   ↓
4. **Если офлайн:**
   - Добавление в очередь IndexedDB
   ↓
5. **При восстановлении связи:**
   - Автоматическая синхронизация всех несинхронизированных событий
   - Отметка как синхронизированных после успешной отправки

### Дедупликация:

- Каждое событие получает уникальный `offline_id` (UUID)
- Сервер проверяет `offline_id` для предотвращения дубликатов
- События с одинаковым `offline_id` не обрабатываются повторно

### Надежность:

- Максимум 5 попыток синхронизации для каждого события
- Автоматическая очистка старых записей (30+ дней)
- Сохранение данных в IndexedDB (не менее 30 дней)
- Логирование ошибок для мониторинга

---

## Использование

### В компонентах:

```typescript
import { queueEvent, queueSession, isOnline } from "@/lib/offline-sync";

// Проверка статуса
if (isOnline()) {
  // Отправка на сервер
} else {
  // Добавление в очередь
  await queueEvent(event);
}
```

### Автоматическая синхронизация:

Синхронизация запускается автоматически при:
- Загрузке приложения
- Восстановлении интернет-соединения
- Периодически (каждые 30 секунд)

---

## Статус

✅ **Все три задачи выполнены:**
1. Офлайн-режим с IndexedDB - реализован
2. Синхронизация с сервером - реализована
3. API эндпоинты - добавлены

**Готово к тестированию и интеграции с бэкендом!**



